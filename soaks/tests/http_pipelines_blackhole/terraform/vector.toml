data_dir = "/var/lib/vector"

##
## Sources
##

[sources.internal_metrics]
type = "internal_metrics"

[sources.logs]
type = "http"
address = "0.0.0.0:8282"
encoding = "text"

##
## Transforms
##

[transforms.preprocessing]
type = "remap"
inputs = ["logs"]
source = '''
., err = parse_json(.message)
if starts_with(strip_whitespace!(.message), "{") {
  custom, err = parse_json(.message)
  if (err == null) {
    .custom, err = compact(custom, string: false)
  }
}
.custom.message = .message
.tags = []
'''

[transforms.processing]
type = "pipelines"
inputs = ["preprocessing"]

[transforms.processing.logs]
order = [
    "nginx",
]

[transforms.processing.logs.pipelines.nginx]
name = "nginx"
filter.type = "datadog_search"
filter.source = "*:*"

[[transforms.processing.logs.pipelines.nginx.transforms]]
type = "remap"
source = '''
if exists(.custom.date_access) {
  .timestamp = .custom.date_access
}
'''

##
## Sinks
##

[sinks.prometheus]
type = "prometheus_exporter"
inputs = ["internal_metrics"]
address = "0.0.0.0:9090"

[sinks.blackhole]
type = "blackhole"
inputs = ["processing"]
